name: picohttp-auto
on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Build xcframework
        run: |
          ./scripts/picohttp-ios-xc.sh
          ditto -c -k --sequesterRsrc --keepParent PicoHTTPParser.xcframework PicoHTTPParser.xcframework.zip
      - name: Checksum
        run: swift package compute-checksum PicoHTTPParser.xcframework.zip > CHECKSUM.txt
      - name: Upstream SHA
        run: echo "UP_SHA=$(cd upstream && git rev-parse HEAD)" >> $GITHUB_ENV
      - name: Next version tag
        shell: bash
        run: |
          LAST=$(git tag --list '[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1)
          test -n "$LAST" || LAST="1.0.0"
          IFS=. read -r MA MI PA <<< "$LAST"
          NEXT="$MA.$MI.$((PA+1))"
          echo "TAG=$NEXT" >> $GITHUB_ENV
      - name: Commit root artifacts
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          rm -rf PicoHTTPParser.xcframework
          mkdir -p PicoHTTPParser.xcframework
          unzip -q PicoHTTPParser.xcframework.zip
          git add Package.swift CHECKSUM.txt PicoHTTPParser.xcframework.zip PicoHTTPParser.xcframework
          git commit -m "auto: refresh PicoHTTPParser.xcframework" || true
          git push origin HEAD:main
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          body: |
            upstream=${{ env.UP_SHA }}
            checksum=$(cat CHECKSUM.txt)
          files: |
            PicoHTTPParser.xcframework.zip
            CHECKSUM.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Prune old releases (keep newest 2)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for t in $(gh release list -L 100 --json tagName,createdAt --jq 'sort_by(.createdAt)|reverse|.[2:]|.[].tagName'); do
            gh release delete "$t" -y
          done
