name: picohttp-auto
on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"
permissions:
  contents: write
jobs:
  build:
    runs-on: macos-15-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          fetch-tags: true

      - name: Build xcframework
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/picohttp-ios-xc.sh
          rm -f PicoHTTPParser.xcframework.zip CHECKSUM.txt
          ditto -c -k --sequesterRsrc --keepParent PicoHTTPParser.xcframework PicoHTTPParser.xcframework.zip

      - name: Checksum
        shell: bash
        run: |
          set -euo pipefail
          swift package compute-checksum PicoHTTPParser.xcframework.zip > CHECKSUM.txt

      - name: Upstream SHA
        shell: bash
        run: |
          set -euo pipefail
          echo "UP_SHA=$(cd upstream && git rev-parse HEAD)" >> "$GITHUB_ENV"

      - name: Next version tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          LAST="$(git tag -l "[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)"
          test -n "${LAST:-}" || LAST="1.0.0"
          IFS=. read -r MA MI PA <<< "$LAST"
          PA=$((PA+1))
          echo "TAG=${MA}.${MI}.${PA}" >> "$GITHUB_ENV"

      - name: Update Package.swift url+checksum
        shell: bash
        run: |
          set -euo pipefail
          SUM="$(tr -d '\n' < CHECKSUM.txt)"
          test -n "${TAG:-}"
          perl -0777 -i -pe "s#url:\\x22https://github.com/quiclane/picohttpparser-spm/releases/download/[^\\x22]+/PicoHTTPParser\\\\.xcframework\\\\.zip\\x22#url:\\x22https://github.com/quiclane/picohttpparser-spm/releases/download/${TAG}/PicoHTTPParser.xcframework.zip\\x22#g; s#checksum:\\x22[0-9a-f]{64}\\x22#checksum:\\x22${SUM}\\x22#g" Package.swift

      - name: Commit root artifacts
        shell: bash
        run: |
          set -euo pipefail
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add Package.swift PicoHTTPParser.xcframework.zip CHECKSUM.txt
          git commit -m "auto: refresh PicoHTTPParser (${TAG})" || true
          git fetch origin main
          git rebase origin/main
          git push origin HEAD:main

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          body: |
            upstream=${{ env.UP_SHA }}
            checksum=$(cat CHECKSUM.txt)
          files: |
            PicoHTTPParser.xcframework.zip
            CHECKSUM.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prune old releases (keep newest 2)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          for t in $(gh release list -L 100 --json tagName,createdAt --jq "sort_by(.createdAt)|reverse|.[2:]|.[].tagName"); do
            gh release delete "$t" -y
          done
